---
title: "TP1: Aplicaci√≥n de modelos conjugados a reviews de Google Maps"
pdf_file: https://github.com/estadisticaunr/estadistica-bayesiana/raw/pdf/trabajos_practicos/01_tp1.pdf
format:
    pdf: # https://quarto.org/docs/reference/formats/pdf.html
        template: ../templates/template.tex
        template-partials:
            - ../templates/title.tex
        # https://pandoc.org/MANUAL.html#placement-of-the-bibliography
        suppress-bibliography: true
    html: default
year: "2023"
course: "Estad√≠stica Bayesiana"
practica: "Trabajo Pr√°ctico 1"
logo: ../templates/logo.png
---

```{r echo=FALSE, include=FALSE}
is_html <- knitr::is_html_output()
options("knitr.graphics.error" = FALSE)
captions <- list()
captions[["cafe"]] <- "El arte latte suele ser distintivo de las cafeter√≠as de especialidad"
captions[["dirichlet"]] <- "Como los valores posibles del vector aleatorio tridimensional yacen en un plano, la distribuci√≥n de probabilidad puede representarse gr√°ficamente con facilidad "
```

::: {.content-visible when-format="html"}

[Descargar PDF]({{< meta pdf_file >}})

:::

# Introducci√≥n

En 2017 comenz√≥ una revoluci√≥n gastron√≥mica en Rosario. La experiencia de tomar caf√© pas√≥
a otro nivel. Comenzaron a aparecer cafeter√≠as con una caracter√≠stica particular: ofrecer
caf√© de especialidad. El caf√© de especialidad comenz√≥ a ganar terreno entre los adeptos al
caf√©.

Una cafeter√≠a de especialidad es una cafeter√≠a en donde el caf√© es lo m√°s importante de 
todo, preparado por baristas, con granos de caf√© de distintas partes del mundo 
(con informaci√≥n meticulosa sobre la finca de la que vienen, la variedad de la planta, 
la altura a la que fue cultivado, y el grado de tueste) y distintos m√©todos de preparaci√≥n
aparte del ya tradicional caf√© de m√°quina espresso (como por ejemplo, los caf√©s filtrados)

```{r, echo=FALSE, out.width="70%", fig.align="center", fig.cap=captions[["cafe"]]}
if (is_html) knitr::include_graphics(file.path("imgs", "cafe.jpg"))
```

La primera cafeter√≠a de especialidad que caus√≥ furor en Rosario fue 
[**Arto**](https://www.instagram.com/artocafe/?hl=es) (Tucum√°n 1932), abierta en 2018. 
Con el correr de los a√±os, el ecosistema cafetero de la ciudad fue agregando locales que 
subieron el umbral de la calidad de caf√© que se consume. En 2022, entre otras, abri√≥
[**Orlan**](https://www.instagram.com/cafeorlan/?hl=es) (Dorrego 1670).

En enero de 2023, en Google Maps, **Arto** tiene una puntuaci√≥n de 4.5‚≠ê 
(en 750 *reviews*) y **Orlan**, una puntuaci√≥n de 4.9‚≠ê (en 95 *reviews*). 
Bas√°ndonos exclusivamente en las *reviews* de Google Maps, ¬øpodemos decir que **Orlan**¬†es
una opci√≥n mejor que **Arto**? ¬øPodr√° la estad√≠stica bayesiana darnos una respuesta?

```{r, echo=FALSE, include=FALSE}
# cantidad de califaciones para cada n√∫mero de estrellas
arto <- data.frame(s = 1:5, r = c(530, 150, 40, 10, 20))
orlan <- data.frame(s = 1:5, r = c(89, 3, 1, 0, 2))
```

En este trabajo se evaluar√°n dos modelos para comparar ambas cafeter√≠as. El supuesto 
inicial del an√°lisis es que las cafeter√≠as tienen una puntuaci√≥n verdadera basada en su 
calidad y medida en ‚≠ê sobre un m√°ximo de cinco. Las opiniones de los usuarios, que 
consideraremos honestas, constituyen observaciones ruidosas de la puntuaci√≥n verdadera. 
Vale la pena recordar que en Google Maps un negocio solo puede recibir un n√∫mero entero 
de ‚≠ê.

# Modelo beta-binomial

En primera instancia, se modelizar√°n las *reviews*¬†como una sucesi√≥n de lanzamientos de 
una moneda sesgada. La moneda tiene un üëçüèº de un lado y un üëéüèº del otro. La probabilidad de
obtener üëçüèº es $\sigma$, que est√° relacionada con la calidad del bar. Luego de tomarse un
cafecito, el cliente arroja la moneda al aire cuatro veces y punt√∫a a la cafeter√≠a seg√∫n
el n√∫mero de üëçüèº que obtuvo.

Seg√∫n esta descripci√≥n, cada *review* es un proceso binomial con cuatro intentos y 
probabilidad de acierto $\sigma$.


1.  Explique la relaci√≥n entre la cantidad de üëçüèº obtenidas al arrojar la moneda y la 
    cantidad puntuaci√≥n en ‚≠ê del bar.
2.  Describa la relaci√≥n entre $\sigma$ y la puntuaci√≥n en ‚≠ê del bar.
3.  Construya una funci√≥n que, dada una puntuaci√≥n real de 1‚≠ê a 5‚≠ê, simule el proceso de
    calificaci√≥n de un usuario.
4.  Construya una funci√≥n que, apoy√°ndose en la apartado anterior, simule las *reviews* de
    $U$ personas.
5.  Simule 1000 veces el proceso de 15 clientes que eval√∫an una cafeter√≠a de 4.1‚≠ê y el 
    proceso de 100 clientes que eval√∫an la misma cafeter√≠a. ¬øQu√© se observa?

Utilizaremos este modelo para realizar inferencias sobre las puntuaciones de **Arto** y 
**Orlan**.

6.  Elija una distribuci√≥n *a priori* para $\sigma$ utilizando una distribuci√≥n beta. 
    ¬øQu√© implicancias tiene para la puntuaci√≥n en ‚≠ê la distribuci√≥n *a priori* elegida? 
    Considere las implicancias para ambas cantidades de *reviews*.
7.  Con los datos de la introducci√≥n, obtenga la distribuci√≥n *a posteriori* de $\sigma$ 
    para cada cafeter√≠a.
8.  ¬øCu√°l es la probabilidad de que **Orlan** sea mejor que **Arto**?

<!--# https://towardsdatascience.com/adding-error-bars-to-5-star-reviews-a-bayesian-approach-d6fef78b3382 -->

# Modelo Dirichlet-multinomial

Trabajaremos a continuaci√≥n con otro modelo, tambi√©n de distribuciones conjugadas. Para 
ello es necesario presentar dos distribuciones de probabilidad: la distribuci√≥n de 
Dirichlet y la distribuci√≥n multinomial.

## Descubriendo la distribuci√≥n de Dirichlet

La distribuci√≥n Dirichlet es en realidad una familia de distribuciones. Se trata de una 
familia de distribuciones de probabilidad continuas y multivariadas. La distribuci√≥n de 
Dirichlet en $K \geq 2$ es la distribuci√≥n de probabilidad del vector aleatorio 
$X=[X_1, X_2 \dots, X_K]$ dimensiones tiene como par√°metro al vector 
$\mathbf{\alpha} = [\alpha_1, \alpha_2, \dots,\alpha_K]$.

$$
f(x_1,x_2,\dots,x_k \mid \alpha_1, \alpha_2,\dots,\alpha_K) = 
    \frac{1}{B(\pmb{\alpha})} \prod_{i=1}^K x_i^{\alpha_i-1}
$$

donde los $\alpha_i \in \mathbb{R}^+$ y $B(\pmb{\alpha})$ es la constante que hace que la 
integral sea unitaria.

El soporte de la distribuci√≥n Dirichlet es tal que 
$\sum_{i=1}^{K} x_i = 1$ y $x_i \in [0,1]$. Es decir, los $x_i$ suman 1. Si consideramos, 
por ejemplo, $K=3$, el vector $[x_1, x_2, x_3]$ pertenece al tri√°ngulo en $\mathbb{R}^3$ 
que tiene por v√©rtices a los puntos $(1,0,0)$, $(0,1,0)$ y $(0,0,1)$. 
As√≠, si $x_1=1$ entonces $x_2=x_3=0$.

M√°s simple a√∫n, cuando $K=2$, el vector $[x_1,x_2]$ pertenece al segmento en 
$\mathbb{R}^2$ que tiene por extremos a los puntos $(1,0)$ y $(0,1)$.

Notar que esta caracter√≠stica hace que los $x_1, x_2, \dots, x_K$ puedan representar las 
probabilidades de un experimento con $K$ resultados posibles.

A t√≠tulo informativo, el soporte de la distribuci√≥n Dirichlet en $K$ dimensiones es lo que
se conoce como _simplex_ (est√°ndar) de $K-1$ dimensiones. El $3$-_simplex_ es un tri√°ngulo
y el $2$-_simplex_ es un segmento. En general, un $K-1$-_simplex_ es la envolvente convexa
de $K$ v√©rtices y, a su vez, es la colecci√≥n de todas las combinaciones convexas de puntos
en el conjunto 
[(Teorema de Carath√©odory)](https://es.wikipedia.org/wiki/Teorema_de_Carath%C3%A9odory).

Los p√°rrafos anteriores, delirantemente matem√°ticos, muestran una virtud particular de la
distribuci√≥n Dirichlet de $K=3$ dimensiones. Esta distribuci√≥n, a pesar de ser de una 
variable aleatoria en $\mathbb{R}^3$, puede representarse perfectamente de manera gr√°fica 
en dos dimensiones (aunque utilizando un sistema de coordenadas peculiar: las coordenadas 
baric√©ntricas), como si se tratara de una distribuci√≥n bivariada.

```{r, echo=FALSE, out.width="70%", fig.align="center", fig.cap=captions[["dirichlet"]]}
if (is_html) knitr::include_graphics(file.path("imgs", "dirichlet.jpg"))
```

<!-- (hacer plots con el paquete \`ggtern\`\`) -->

1.  Mostrar que, cuando $K=2$, la distribuci√≥n de Dirichlet es la distribuci√≥n beta de 
    par√°metros $a=\alpha_1$ y $b=\alpha_2$

## Relaci√≥n entre la distribuci√≥n Dirichlet y la multinomial

Cuando un experimento puede tener dos resultados posibles, uno de ellos tiene probabilidad
$p$ y el otro probabilidad $1-p$. Si coleccionamos $N$ realizaciones independientes del 
experimento, el n√∫mero de √©xitos es una variable aleatoria con distribuci√≥n binomial. 
Estudiamos que era natural utilizar la distribuci√≥n beta como distribuci√≥n *a priori* para
$p$, dado que la distribuci√≥n *a posteriori*¬†tambi√©n era beta.

An√°logamente, cuando un experimento puede tener tres resultados posibles, el primero tiene
probabilidad $p_1$, el segundo tiene probabilidad $p_2$ y el tercero, probabilidad 
$p_3 = p_1 - p_2$. Necesariamente debe ser $p_1 + p_2 + p_3 = 1$. Si coleccionamos $N$ 
realizaciones independientes del experimento, el n√∫mero de ocurrencias de cada resultado
posible es un vector aleatorio con distribuci√≥n multinomial. Por lo visto hasta aqu√≠, todo
parece indicar que, si queremos realizar inferencias sobre $p_1$, $p_2$ y $p_3$, ser√≠a 
natural utilizar la distribuci√≥n Dirichlet de tres dimensiones como distribuci√≥n 
*a priori* para las probabilidades...

En efecto, cuando la distribuci√≥n *a priori* es Dirichlet y la verosimilitud es 
multinomial, la distribuci√≥n *a posteriori* tambi√©n es Dirichlet.

2.  Sabemos que para una verosimilitud binomial, si la distribuci√≥n *a priori* de la 
    probabilidad de √©xito $p$ es beta de par√°metros $a$ y $b$ y se observan $s$ √©xitos en 
    $N$ intentos independientes, la distribuci√≥n *a posteriori* es beta de par√°metros 
    $a' = a + s$ y $b' = b + (N - s)$.
 
    Hallar, por analog√≠a con el caso anterior, los par√°metros de la distribuci√≥n 
    *a posteriori* que se obtiene si la verosimilitud es multinomial con tres resultados 
    posibles, la distribuci√≥n a priori¬†es Dirichlet de par√°metros 
    $[\alpha_1, \alpha_2, \alpha_3]$ y se obtuvieron $s_1$ veces el primer resultado y 
    $s_2$ veces el segundo resultado, sobre un total de $N$ intentos.

## Aplicaci√≥n

Asumiremos ahora que las *reviews* de un local tienen distribuci√≥n multinomial de 
par√°metros $[p_1, p_2, \dots, p_5]$. Es decir, la probabilidad de que un usuario asigne 
1‚≠ê es $p_1$, de que asigne 2‚≠ê es $p_2$, y as√≠ sucesivamente. Llamaremos $n_1$ al n√∫mero
de calificaciones de 1‚≠ê, $n_2$ al n√∫mero de calificaciones de 2‚≠ê, y as√≠ sucesivamente.
$n_1 + n_2 + n_3 + n_4 + n_5 = N$ ser√° el n√∫mero total de *reviews*.

Se puede verificar que el n√∫mero esperado de reviews de $i$‚≠ê ser√° $N p_i$. 
Por lo tanto, la puntuaci√≥n esperada ser√°:

$$
\frac{1}{N} (1\cdot N p_1 + 2\cdot N p_2 + 3\cdot N p_3 + 4\cdot N p_4 +5\cdot N p_5) = 
    \sum_{i=1}^5 i \cdot p_i
$$

3.  Elija dos combinaciones de posibles valores de $p_i$ que den un valor esperado de 
    4.1‚≠ê. Piense en una combinaci√≥n que represente acuerdo entre los clientes y otra que 
    indique la presencia de opiniones dispares.
4.  Escriba una funci√≥n que, dada una combinaci√≥n de valores de $p_i$, simule el proceso 
    de calificaci√≥n de un cliente.
5.  Construya una funci√≥n que simule la calificaci√≥n de $U$ clientes.
6.  Simule 1000 veces el proceso de 15 clientes que eval√∫an una cafeter√≠a de 4.1‚≠ê y el 
    proceso de 100 clientes que eval√∫an la misma cafeter√≠a. ¬øQu√© se observa?

Utilizaremos este nuevo modelo para realizar inferencias sobre las puntuaciones de 
**Arto** y **Orlan**.

7.  Los datos se generan siguiendo una distribuci√≥n multinomial. ¬øCu√°les son los 
    par√°metros de esa distribuci√≥n multinomial? ¬øQu√© distribuci√≥n *a priori* ser√≠a 
    conveniente utilizar? ¬øC√≥mo est√° parametrizada esa distribuci√≥n *a priori*?
8.  Elija los par√°metros de la distribuci√≥n *a priori* de modo tal que la creencia inicial
    sea uniforme sobre los posibles valores de los $p_i$. ¬øQu√© implicancias tiene para la 
    puntuaci√≥n en ‚≠ê la distribuci√≥n *a priori* elegida?
9.  Con los datos de la introducci√≥n, obtenga la distribuci√≥n *a posteriori* de los $p_i$ 
    para cada cafeter√≠a.
10. ¬øCu√°l es la probabilidad de que **Orlan** sea mejor que **Arto**?

<!--# Principalmente de: https://fulmicoton.com/posts/bayesian_rating/ -->
<!--# Un an√°lisis adicional en: https://www.evanmiller.org/ranking-items-with-star-ratings.html -->
