---
title: "Práctica - Unidad 3"
bibliography: ../references.bib
nocite: |
    @Martin2021, @Downey2021
pdf_file: https://github.com/estadisticaunr/estadistica-bayesiana/raw/pdf/practica/practica_03.pdf
---

```{r echo=FALSE, include=FALSE}
is_html <- knitr::is_html_output()
options("knitr.graphics.error" = FALSE)
source(here::here("scripts", "utils.R"))
captions <- list()
captions[["monty_hall"]] <- "Las 3 puertas del problema de Monty Hall"


library(dplyr)
library(ggplot2)
library(patchwork)
```

::: {.content-visible when-format="html"}
[Descargar PDF]({{< meta pdf_file >}})
:::

## Métodos Computacionales

1.  Sea $X \sim \text{Normal}(\mu=3, \sigma=1.2)$. 
    i. Elabore un gráfico que permita visualizar la función de densidad de probabilidad 
    de $X$.
    i. ¿Cuál es la probabilidad de que $X$ sea menor a 2.5?
    i. ¿Cuál es la probabilidad de que $X$ sea mayor a 4?
    i. ¿Cuál es la probabilidad de que $X$ sea mayor 2 y menor 3?

1.  Sea $X \sim \text{Beta}(\alpha=10, \beta=2)$
    i. Elabore un gráfico que permita visualizar la función de densidad de probabilidad 
    de $X$.
    i. ¿Cuál es la probabilidad de que $X$ sea menor a 0.5?
    i. ¿Cuál es la probabilidad de que $X$ sea mayor a 0.8?
    i. ¿Cuál es la probabilidad de que $X$ sea mayor 0.25 y menor 0.75?

1.  Responda los dos puntos anteriores sin evaluar la función de densidad ni la función
    de distribución de las variables aleatorias mencionadas. Para eso genere muestras
    que provengan de las correspondientes distribuciones y utilícelas para responder las 
    preguntas mencionadas. Reflexione sobre las ventajas y desventajas de utilizar un 
    enfoque basado en la simulación para resolver problemas.

1.  Una variable aleatoria $X$ toma valores en el conjunto $\{2, 4, 6, 8, 10\}$ con igual
    probabilidad. Encuentre la media y el desvío estándar de las variables $X$ e 
    $Y = 2X + 1$.
    <!-- Tal vez se puede hacer un poco más difícil si hacemos que la función sea no-lineal -->

1.  En un problema determinado la distribución a posteriori de la parámetro de inteŕes
    $\alpha$ es $\Gamma(k=3, \theta=1.5)$, donde $k$ es el parámetro de forma y $\theta$ 
    es el parámetro de escala. Calcule la probabilidad de que $\alpha^2$ sea mayor a 10.
    <!-- https://stats.stackexchange.com/questions/154135/square-of-gamma-random-variable -->

1.  Sean $X$ e $Y$ dos variables aleatorias independientes con distribución uniforme en el
    intervalo $[0, 1]$. 

    i.  ¿Cuál es la probabilidad de que $X \le Y$?
    i.  Grafique los puntos muestreados coloreando de acuerdo a si la muestra satisface
    el evento antes mencionado o no.

1.  Dos estudiantes de estadística deciden encontrarse en la fotocopiadora de la Facultad
    entre las 10 y las 11 de la mañana, eligiendo el tiempo de llegada al azar. 
    La estudiante A esperará 10 minutos luego de llegar. Si el estudiante B no llega en
    ese intervalo, se irá. Lo mismo hace el estudiante B, pero este decide esperar
    14 minutos. ¿Cuál es la probabilidad de que se produzca el encuentro en la 
    fotocopiadora entre la estudiante A y el estudiante B?

1.  Una máquina que se utiliza para ensamblar teléfonos celulares en una fábrica en 
    Tierra del Fuego cuenta con tres componentes críticos para su funcionamiento. 
    Ante una falla en cualquiera de estos componentes, la máquina se detiene. 
    Las probabilidades de que estos elementos operen correctamente durante un día 
    cualquiera  son $p_1 = 0.8$, $p_2 = 0.9$ y $p_3 = 0.7$. 
    Responda las siguientes preguntas utilizando técnicas de simulación:

    i.  ¿Cuál es la probabilidad de que la máquina falle en el primer día de uso?
    i.  ¿Cuál es la probabilidad de que la máquina siga funcionando luego de 10 días?
    i.  ¿Cuál es la probabilidad de que la máquina falle en el día 7 de uso?
    i.  Sea $T=$ Cantidad de días que la máquina funciona ininterrumpidamente. 
    Grafique la función de densidad de probabilidad de $T$.

1.  [Este tuit](https://twitter.com/pgroisma/status/1616137795180822528) propone un
    problema muy interesante. Una urna contiene una bola azul y una amarilla. 
    Se elije una bola al azar y se la vuelve a colocar junto con otra bola adicional 
    del mismo color. Se repite este proceso indefinidamente. 
    ¿Qué ocurre con la proporción de bolas azules en la urna a medida que 
    repetimos más y más veces?

    i. Tiende a 1/2
    i. Tiende a 0 ó a 1
    i. No se estabiliza
    i. Ninguna de las anteriores

    Escriba un programa en `R` para responder esta pregunta utilizando simulaciones.
    Genere gráficos que faciliten la comprensión del resultado.

1.  ¿Cuánto vale $\pi$?

    Imagine un círculo de radio $r$ y un cuadrado de lado $2r$, ambos centrados en el 
    mismo punto, que de manera arbitraria puede ser el punto $(0, 0)$. Obtenga muestras
    de una distribución uniforme en el plano $(x, y)$, cuyo dominio está acotado por 
    el cuadrado antes mencionado. Para cada muestra extraida, determine si se encuentra 
    dentro del círculo o no -- todos las muestras se encontrarán dentro del cuadrado. 
    Utilice esta información para estimar el valor de $\pi$.
    
    ```{r circulo-cuadrado-pi}
    #| warning: false
    #| echo: false
    #| fig.width: 4.5
    #| fig.height: 4.5
    #| fig.align: center
    centro <- c(0, 0)
    radio <- 1
    angulos <- seq(0, 2 * pi, length.out = 512)

    x_circulo <- centro[1] + radio * cos(angulos)
    y_circulo <- centro[2] + radio * sin(angulos)

    x_cuadrado <- c(
        seq(-1, 1, length.out = 128),
        rep(1, 128),
        seq(1, -1, length.out = 128),
        rep(-1, 128)
    )
    y_cuadrado <- c(
        rep(1, 128), 
        seq(1, -1, length.out = 128), 
        rep(-1, 128), 
        seq(-1, 1, length.out = 128)
    )

    x <- c(x_circulo)
    y <- c(y_circulo)
    figura <- rep(c("circulo", "cuadrado"), each = 512)
        
    df <- data.frame(x = x, y = y, figura = figura)
    ggplot(df) + 
        geom_hline(yintercept = 0, linetype = "dashed", color = "#999999") +
        geom_vline(xintercept = 0, linetype = "dashed", color = "#999999") +
        geom_path(aes(x = x, y = y), size = 1.25, color = "#0984C0") +
        geom_rect(
            xmin = -1, xmax = 1, ymin = -1, ymax = 1, 
            fill = NA, color = "#999999", size = 1.25
        )
    ```

    Datos útiles

    * Area de un círculo: $\pi \cdot r^2$.
    * Area de un cuadrado: $a^2$, donde $a$ es la longitud del lado.

1.  Se seleccionan dos puntos de manera uniforme e independiente dentro de un círculo. 
    ¿Cuál es la probabilidad de que la distancia entre dos puntos sea menor al radio?

    i.  Intentar hacer a mano?
    i.  Resuelva el problema utilizando `R`
    i.  Elabore una visualización que facilite la comunicación de los resultados

1.  En la Copa del Mundo de la FIFA 2014, Alemania jugó contra Brasil en la semifinal. 
    Los alemanes hicieron el primer gol a los 11 minutos y el segundo a los 23.
    Asuma que el tiempo entre goles sigue una distribución exponencial. 
    Elija una distribución _a priori_ para el tiempo entre goles (puede ser conjugada o 
    no). En ese momento del partido,

    i. ¿Cuál es la distribución _a posteriori_ del tiempo entre goles de Alemania?
    i. ¿Cuántos goles cabría esperar que Alemania hiciera al finalizar los 90 minutos?
    i. ¿Cuál era la probabilidad de que Alemania hiciera más de 5 goles (cosa que ocurrió)?
    <!-- http://allendowney.github.io/ThinkBayes2/chap08.html -->

1.  **¿Tendré que esperar mucho?**

    El tiempo que un empleado de recursos humanos demora en hacer una entrevista tiene
    distribución exponencial con media 30 minutos. Los tiempos de duración de cada 
    entrevista se pueden considerar independientes entre sí. 
    Las entrevistas a postulantes para un trabajo están programadas cada 15 minutos, 
    comenzando desde las 8. Es válido considerar que todos los postulantes llegan 
    puntuales a su entrevista. Cuando la persona del turno de las 8:15 llega a la oficina

    i. ¿Cuál es la probabilidad de que tenga que esperar antes de ser entrevistada?
    i. ¿Cuál es el horario esperado al que terminará su entrevista?
    <!-- Modern Data Science with R -->

1.  **¡Qué casualidad!**
    
    Dos personas se conocen en la fila de embarque para un vuelo en un avión Airbus 
    A330-300

    i. ¿Cuál es la probabilidad de que tengan asientos en la misma fila?
    i. ¿Cuál es la probabilidad de que estén sentados en asientos adyacentes?

1.  **El Problema de Monty Hall**

    El Problema de Monty Hall es un problema de probabilidad basado en un juego del
    concurso televisivo estadounidense "Trato hecho". 
    En este problema, el concursante debe elegir una puerta entre tres, todas cerradas. 
    El premio consiste en llevarse lo que se encuentra detrás de la elegida. 
    Se sabe con certeza que tras una de ellas se oculta un automóvil, y tras las otras dos 
    hay cabras. Una vez que el concursante haya elegido una puerta y comunicado su elección a 
    los presentes, el presentador, que sabe lo que hay detrás de cada puerta, abrirá una de las
    otras dos en la que haya una cabra. A continuación, le da la opción al concursante de 
    cambiar, si lo desea, de puerta (tiene dos opciones). 
    ¿Debe el concursante mantener su elección original o escoger la otra puerta? 
    ¿Hay alguna diferencia? Resuelva este ejercicio utilizando simulaciones.
    <!-- Modern Data Science with R -->


    ```{r, echo=FALSE, out.width="70%", fig.align="center", fig.cap=captions[["monty_hall"]]}
    if (is_html) knitr::include_graphics(file.path("imgs", "monty_hall.png"))
    ```

1.  **Que los cumplan feliz**

    Basándose en el [siguiente tuit](https://twitter.com/Kit_Yates_Maths/status/1542767039814713346)
    y conociendo el problema del cumpleaños (¿cuántas personas debe
    haber en una habitación para que la probabilidad de que dos de ellas
    cumplan años el mismo día sea mayor a X%?) construir un gráfico
    similar al del tuit donde se grafique la probabilidad de que haya
    $n$ personas que cumplan años el mismo día para $K$ personas
    presentes en la habitación.

1.  **Qué suerte, ¿no?**
    
    Previo a la final de la Copa América 2021, los jugadores de la Selección Argentina se
    reúnen en la habitación del hotel como se describe en 
    [este tuit](https://twitter.com/PlanetaDeCABJ/status/1587925636869300224).

    i. ¿Cuál es la probabilidad de que un jugador adivine una de diez cartas?
    i. ¿Cuál es la probabilidad de que tres de ellos adivinen una de diez cartas?

1.  **El álbum del Campeón**

    El álbum oficial del Mundial de Fútbol de Qatar 2022 consta de 638 figuritas. 
    Cada paquete trae cinco figuritas.

    i. Comprando cinco paquetes, ¿cuál es la probabilidad de tener a Messi?
    i. Comprando cinco paquetes, ¿cuál es la probabilidad de sacar a Messi repetido?
    i. ¿Cuántos paquetes se necesitan, en promedio, para completar el álbum?
    i. Si a una persona le faltan diez figuritas para completar el álbum, 
    ¿cuántos paquetes tiene que comprar para asegurarse de lograrlo?

1.  **¿Que tán raras son estas secuencias raras?**

    Si se arroja una moneda $n$ veces, ¿cuál es la probabilidad de que no haya secuencias 
    de $k$ caras?

1.  **Un viaje por el elevador**

    ¿Cuál es la probabilidad de que tres personas en un ascensor con doce pisos presionen 
    para ir a tres pisos consecutivos? ¿Qué supuestos realiza para resolver el problema?
    Escríbalos en una lista de manera explícita.
   
1.  **La vida es muy corta como para perderla ordenando medias**
    
    Un cajón contiene 10 pares de medias. No hay dos pares iguales. 
    Por fiaca, el dueño de las medias no las agrupa después de lavarlas y simplemente las
    pone en el cajón. Al momento de necesitar un par de medias, saca una tras una hasta 
    que se forma un par. En promedio, ¿cuántas medias sacará hasta encontrar un par?
    <!-- https://fivethirtyeight.com/features/can-you-find-a-matching-pair-of-socks/ -->
    
1.  **¿Vale la pena hacer un ensayo clínico a gran escala?**

    Dados los resultados de un estudio piloto, la probabilidad _a posteriori_ de que la droga
    desarrollada por tu compañía sea mas efectiva que el tratamiento actual es $\theta \in [0, 1]$.
    Tu compañía está considerando realizar un ensayo clínico a gran escala para confirmar que
    la droga que desarrollan es de hecho mejor. El costo del estudio es **\$X**. 
    Si la droga es mejor, la probabilidad de que esto se confirme en el ensayo es del 80%.
    Si la droga no es mejor, hay una probabilidad del 5% de que el estudio confirme que es mejor.
    Si el ensayo sugiere que tu droga es mejor, ganarás **\$cX**. 
    ¿Para qué valores de $\theta$ y $c$ tiene sentido realizar el estudio?
    <!-- @Reich2020 -->

1.  **El problema de concordancia**

    Resuelva el problema de concordancia de de Montmort presentado en la **Práctica 0**
    utilizando simulaciones.
    <!-- Blitzstein, Introdudction to Probability -->

1.  **El problema de los sobres**

    Resuelva el problema de los dos sobres presentado en la **Práctica 0** utilizando 
    simulaciones.

1.  **Integración por muestreo**

    Calcule las siguientes integrales utilizando muestras.

    i. $\displaystyle \int_{-\infty}^{\infty}{\frac{x^2}{\sqrt{2\pi}}\exp \left(-\frac{x^2}{2} \right)dx}$
    i. $\displaystyle \int_{1}^{\infty}{\frac{x^3}{\sqrt{2\pi}}\exp \left(-\frac{x^2}{2} \right)dx}$
    i. $\displaystyle \int_{1}^{\infty}{\frac{x^6}{\sqrt{2\pi}}\exp \left(-\frac{x^2 - 4x}{2} \right)dx}$
    i. $\displaystyle \int_{1}^{10}{x^6\frac{e^{-x^4/2}}{\sqrt{2\pi}}dx}$
    <!-- @Lambert2018 Capitulo 9 -->

1.  ¿Cuál es la distribución de muestreo aproximada al usar muestreo independiente para 
    evaluar integrales?
    <!-- @Lambert2018 Capitulo 9 -->

## Método de la grilla

Podriamos encontrar un mejor nombre...

1. **Aproximación de grilla**

    Se tiene un experimento binomial donde $n=80$ y se observan $y=7$ éxitos. 
    Considere que el _prior_ de la probabilidad de éxito $\theta$ es $\text{Beta}(2, 10)$.

    i. Obtenga la distribución _a posteriori_ de $\theta$ de manera analítica y grafíquela.
    i. Obtenga la distribución _a posteriori_ de $\theta$ utilizando el método de la 
    grilla en base a una grilla de 10 puntos y dibuje la curva obtenida en el gráfico 
    creado anteriormente.
    i. Repita el proceso del punto anterior utilizando una grilla de 100 puntos.
    i. Concluya sobre la fidelidad de las aproximaciones. ¿Considera que es necesario
    utilizar una grilla más densa? ¿Cuáles serían las ventajas y desventajas?

1. **Cálculo de probabilidades en base a la grilla (I)**

    En base al _posterior_ obtenido en el ejercicio anterior mediante el método de la 
    grilla calcule las siguientes probabilidades

    * $P(\theta < 0.7)$
    * $P(\theta > 0.05)$
    * $P(0.05 < \theta < 0.15)$

    De ser necesario, obtenga el _posterior_ mediante una grilla de mayor densidad.

1. **Cálculo de probabilidades en base a la grilla (II)**

    Utilice los valores de la grilla y sus probabilidades _a posteriori_ para obtener
    muestras del _posterior_ y calcular las mismas probabilidades que en el ejercicio
    anterior en base a muestras. Ayuda: Para obtener muestras utilice la función `sample()`.


1.  **Aproximación de grilla en 2 dimensiones**

    Sean dos variables aleatorias continuas $X$ e $Y$ tales que $(X, Y) \in \mathbb{R}^2$,
    y sea el siguiente modelo de regresión lineal simple:

    $$
    \begin{aligned}
    \alpha &\sim \text{Normal}(0, 1.5) \\
    \beta  &\sim \text{Normal}(0, 2) \\
    Y      &\sim \text{Normal}(\alpha + \beta X, 0.8)
    \end{aligned}
    $$

    i. Obtenga el _posterior_ conjunto del vector de parámetros $[\alpha, \beta]^T$ 
    mediante el método de la grilla. Elabore un gráfico que permita visualizar esta 
    distribución.
    i. Obtenga el _posterior_ marginal de $\alpha$ y grafíquelo.
    i. Obtenga el _posterior_ marginal de $\beta$ y grafíquelo.
    i. Calcule la probabilidad de que el intercepto sea mayor a 0.5.
    i. Calcule la probabilidad de que la pendiente sea menor a -3.
    
    Para responder las consignas utilice los datos simulados que se obtienen con el 
    siguiente bloque de código:

    ```{r}
    set.seed(121195)
    alpha <- 1
    beta <- -2
    sigma <- 0.8
    n <- 80
    x <- rnorm(n)
    y <- rnorm(n, alpha + beta * x, sigma)
    df <- data.frame(x = x, y = y)
    ```

    **Bonus:** ¿Cómo podría responder las consignas (ii)-(v) utilizando muestras del 
    _posterior_? 

    ```{r scatterplot-lin-reg}
    #| eval: false
    #| warning: false
    #| echo: false
    #| fig.width: 5.5
    #| fig.height: 4.5
    #| fig.align: center
    # Generar gráfico de dispersión para ver los datos
    plt <- ggplot(df, aes(x = x, y = y)) +
        geom_point(alpha = 0.6, fill = "gray60", size = 2)
    plt
    ```

    ```{r}
    #| eval: false
    #| warning: false
    #| echo: false
    #| fig.width: 5.5
    #| fig.height: 4.5
    #| fig.align: center

    # Esto es una posible solución a la primera parte
    grid_a <- seq(0.5, 1.5, length.out = 50)
    grid_b <- seq(-2.5, -1.5, length.out = 50)
    grid_df <- expand.grid(grid_a, grid_b)

    names(grid_df) <- c("a", "b")
    likelihood <- numeric(nrow(grid_df))
    posterior <- numeric(nrow(grid_df))

    # No se que problema hay si lo hago con `mutate()` que todo queda en 0.
    for (i in seq_along(likelihood)) {
        likelihood[i] <- prod(dnorm(y, grid_df$a[i] + grid_df$b[i] * x, sigma))
    }
    posterior <- (
        likelihood 
        * dnorm(grid_df$a, mean = 0, sd = 1.5) # alpha ~ Normal(0, 1.5)
        * dnorm(grid_df$b, mean = 0, sd = 2)   # beta ~ Normal(0, 2)
    )

    grid_df$likelihood <- likelihood
    grid_df$posterior <- posterior

    plt <- ggplot(grid_df, aes(x = a, y = b)) +
        geom_raster(aes(fill = posterior)) +
        stat_contour(aes(z = posterior), col = "white", bins = 5) +
        geom_point(x = alpha, y = beta, color = "black", fill = "red", size = 3, pch = 21) + 
        labs(x = expression(alpha), y = expression(beta)) +
        viridis::scale_fill_viridis() + 
        theme(legend.position = "none")
    plt
    ```

1.  **Escalando la aproximación de la grilla**

    Suponga que se tiene que estimar un _posterior_ utilizando la aproximación mediante
    una grilla de 200 puntos en cada dimensión. Calcule cúantas veces se tiene que evaluar
    el posterior en cada uno de los siguientes escenarios:

    i. 1 dimensión
    i. 2 dimensiones
    i. 3 dimensiones
    i. 5 dimensiones
    i. 10 dimensiones

    Concluya sobre las ventajas y desventajas de la aproximación de la grilla teniendo
    en cuenta sus características conforme se incrementa el número de dimensiones del
    _posterior_.

1.  **_Benchmark_ de la aproximación de la grilla**
    
    El siguiente bloque de código define una función llamada `create_and_eval_grid()` 
    que evalúa la función de densidad normal en una cantidad arbitraria dimensiones. 
    El argumento `dimension_n` indica la dimensionalidad de la distribución normal, y 
    `grid_n` indica la cantidad de puntos en la grilla de cada dimensión. Debajo, 
    se utiliza la función `mark()` del paquete `bench` para comparar el desempeño de la
    función `create_and_eval_grid()` con diferentes números de dimensiones.

    ```{r}
    #| eval: false
    create_and_eval_grid <- function(dimension_n, grid_n = 100) {
        grid <- seq(-3, 3, length.out = grid_n)
        grids <- replicate(dimension_n, grid, simplify = FALSE)
        df <- expand.grid(grids, KEEP.OUT.ATTRS = FALSE)
        Mu <- rep(0, dimension_n)
        Sigma <- diag(dimension_n)
        mvtnorm::dmvnorm(df, mean = Mu, sigma = Sigma)
    }
    bench::mark(
        create_and_eval_grid(1),
        create_and_eval_grid(2),
        check = FALSE,
        max_iterations = 500
    )
    ```

    Modifique el código brindado para evaluar la función de densidad en hasta un máximo
    de 10 dimensiones. Concluya sobre el tiempo de ejecución, el consumo de memoria, y 
    otras cantidades que se encuentren en la salida y crea adecuadas para el análisis.

1.  Grid approximation para una _skew-normal_. Estimar los parámetros $\xi$ (posición), 
    $\omega$ (escala) y $\alpha$ (asimetría).
    
    $$
    f(x) = \frac{2}{\omega} \phi\left(\frac{x-\xi}{\omega}\right)\Phi\left( \alpha \frac{x-\xi}{\omega} \right)
    $$
    <!-- https://en.wikipedia.org/wiki/Skew_normal_distribution -->

## **Metropolis-Hastings**

Están escritos bastante así nomás.

1.  Obtener muestras de las siguientes distirbuciones univariadas 
    i. Uniforme
    i. Normal
    i. Gamma
    i. Beta
    i. T-Student
    i. Alguna otra univariada no tan trivial?

1.  Obtener muestras de la siguientes distribuciones normal multivariada
    i. Independiente
    i. Correlacion debil
    i. Correlacion fuerte

1.  Repetir los cálculos de los puntos anteriores utilizando 4 cadenas y 
    calcular $\hat{R}$.

1.  Demostrar que la distribución estacionaria del algoritmo de Metropolis-Hastings es
    la distribución objetivo $p(\pmb{\theta} | \mathbf{y})$

1.  Ajustar algun modelo conjugado (y por que no, otro no conjugado), utilizando MH

## **Hamiltonian Monte Carlo (HMC) y el Not-U-Turn Sampler (NUTS)**

## **Diagnósticos**

1.  Generar traceplots
1.  Calcular y graficar funcion de autocorrelacion
1.  Calcular tamaño efectivo de muestras
1.  Calcular $\hat{R}$ usando muestras independientes de un _posterior_
    i. Calcular variabilidad intra cadenas
    i. Calcular variabilidad entre cadenas
1.  Calcular $\hat{R}$ usando un muestras dependientes de un _posterior_
    i. Calcular variabilidad intra cadenas
    i. Calcular variabilidad entre cadenas
1.  Calcular tamaño efectivo de muestra utilizando muestras independientes de un _posterior_
1.  Calcular tamaño efectivo de muestra utilizando muestras dependientes de un _posterior_
1.  Algo más?

1.  Describir que problema muestran las siguientes cadenas... WIP? 

    ```{R}
    #| warning: false
    #| echo: false
    set.seed(121195)
    STEPS <- 150

    plot_trace_and_histogram <- function(df) {
        plt_lines <- ggplot(df, aes(x = x, y = y, color = chain)) +
            geom_line(size = 1.2) + 
            labs(x = "Número de muestra", y = "Valor") + 
            guides(color = guide_legend(title = NULL)) +
            theme(
            legend.position = "top",
            legend.text = element_text(size = 12)
            )
        
        plt_hist <- ggplot(df, aes(y = y, fill = chain)) +
            geom_histogram(bins = 40, alpha = 0.7, position = "identity") +
            theme(
            axis.title = element_blank(),
            axis.text = element_blank(),
            axis.ticks = element_blank(),
            legend.position = "none"
            )
        plt <- plt_lines + plt_hist + plot_layout(widths = c(5, 1))
        return(plt)
    } 
    ```

    ```{R trace-and-histogram-1}
    #| warning: false
    #| echo: false
    #| fig.width: 8
    #| fig.height: 4.5
    #| fig.align: center
    x <- rep(seq(STEPS), times = 2)
    y1 <- rnorm(STEPS)
    y2 <- rnorm(STEPS) + 5
    chain <- rep(c("Cadena 1", "Cadena 2"), each = STEPS)
    df <- data.frame(x = x, y = c(y1, y2), chain = chain)
    plot_trace_and_histogram(df)
    ```

    ```{R trace-and-histogram-2}
    #| warning: false
    #| echo: false
    #| fig.width: 8
    #| fig.height: 4.5
    #| fig.align: center
    steps <- 150
    x <- rep(seq(steps), times = 2)
    y1 <- 0.035 * seq(steps) + rnorm(steps, sd = 0.4)
    y2 <- -0.035 * seq(steps) + rnorm(steps, sd = 0.4) + 5
    chain <- rep(c("Cadena 1", "Cadena 2"), each = STEPS)
    df <- data.frame(x = x, y = c(y1, y2), chain = chain)

    plot_trace_and_histogram(df)
    ```

    ```{R trace-and-histogram-3}
    #| warning: false
    #| echo: false
    #| fig.width: 8
    #| fig.height: 4.5
    #| fig.align: center
    steps <- 150
    x <- rep(seq(steps), times = 2)
    y1 <- 0.035 * seq(steps) + rnorm(steps, sd = 0.4)
    y2 <- 0.035 * seq(steps) + rnorm(steps, sd = 0.4) + 5
    chain <- rep(c("Cadena 1", "Cadena 2"), each = STEPS)
    df <- data.frame(x = x, y = c(y1, y2), chain = chain)

    plot_trace_and_histogram(df)
    ```



## **Programción probabilística**

1.  Escribir y ajustar algunos modelos con Stan
    * Comparar salidas con resultados teóricos

## **Otros**

1.  Una compañía pesquera de Comodoro Rivadavia se encuentra probando un nuevo método para
    estimar el peso de los peces que extrae del Mar Argentino. El objetivo de este método
    es obtener una estimación lo suficientemente buena del peso de cada pescado sin tener
    que pesarlos uno por uno, ya que es un proceso costoso en tiempo y labor. 
    Para eso, seleccionaron una muestra de pescados, los pesaron
    y les midieron ciertos aspectos morfológicos (ancho, alto y largo). En el futuro,
    esperan recolectar estas mismas medidas morfológicas mediante una cámara especializada
    y utilizar un modelo para estimar el peso.
    
    El modelo propuesto por el equipo de investigación es el siguiente:

    **NOTA:** Tal vez este ejercicio queda mejor en la práctica 4?

    $$
    \begin{aligned}
    \log(\text{Peso}_i) &\sim \text{Normal}(\mu, \sigma) \\
    \mu_i  &= \beta_0 + \beta_1 \log(\text{Largo}_i) \\
    \sigma &\sim \text{Gamma}(k, \theta)
    \end{aligned}
    $$

    El peso se encuentra medido en gramos y la longitud en centímetros. El equipo provee 
    las muestras que obtuvieron del _posterior_. Las mismas se pueden leer en `R` 
    utilizando el siguiente bloque de código. 

    ```{r}
    #| eval: false
    url <- paste0(
        "https://raw.githubusercontent.com/estadisticaunr/estadistica-bayesiana/",
        "main/datos/fish-market-posterior.csv"
    )
    df_posterior <- readr::read_csv(url)
    head(df_posterior)
    ```
    ```
    # A tibble: 6 × 3
      intercepto pendiente sigma
           <dbl>     <dbl> <dbl>
    1      -4.44      3.08 0.408
    2      -4.30      3.05 0.431
    3      -4.49      3.12 0.433
    4      -4.04      2.96 0.341
    5      -4.76      3.18 0.413
    6      -4.65      3.15 0.350
    ```

    i.  Analice de manera gráfica y analítica los _posteriors_ marginales de los 
    parámetros del modelo. Realice las transformaciones de parámetros que crea
    conveniente para facilitar la comprensión del análisis.
    i.  Considere un pescado cuya longitud es de 30 centímetros.
        a. Obtenga y grafique la distribución _a posteriori_ del peso medio.
        a. Obtenga y grafique la distribución predictiva _a posteriori_ del peso.
        a. Interprete los resultados. 
    i.  Grafique la curva de regresión junto a una banda de credibilidad del 95% 
    en el plano de las variables originales y en el plano de las variables transformadas.
    i.  Agregue a los gráficos anteriores una banda de credibilidad del 95% para la 
    distribución predictiva _a posteriori_. Interprete los resultados.

1.  Considere la siguiente familia de distribuciones normales en 2D

    $$
    f(\mathbf{x} | \pmb{\Sigma}, \pmb{\mu} = \mathbf{0}) 
    = \frac{1}{\det(2\pi\pmb{\Sigma})^{-\frac{1}{2}}}
    \exp[{-\frac{1}{2} \mathbf{x}^T \pmb{\Sigma}^{-1} \mathbf{x}}]
    $$

    y las siguientes matrices de covarianza

    $$
    \begin{array}{c}
        \pmb{\Sigma}_1 = \begin{bmatrix}
        1 & 0 \\ 0 & 1
        \end{bmatrix}
        &
        \pmb{\Sigma}_2 = \begin{bmatrix}
        1 & 0.2 \\ 0.2 & 1
        \end{bmatrix}
        \\ \\ 
        \pmb{\Sigma}_1 = \begin{bmatrix}
        1 & 0.5 \\ 0.5 & 1
        \end{bmatrix}
        &
        \pmb{\Sigma}_2 = \begin{bmatrix}
        0.1 & 0 \\ 0 & 1
        \end{bmatrix}
        \\ \\
        \pmb{\Sigma}_1 = \begin{bmatrix}
        1 & 0.9 \\ 0.9 & 1
        \end{bmatrix}
        &
        \pmb{\Sigma}_2 = \begin{bmatrix}
        0.01 & 0 \\ 0 & 1
        \end{bmatrix}
    \end{array}
    $$

    Que dan lugar a las siguientes funciones de densidad:

    ```{r plot-matrix-of-gaussians}
    #| warning: false
    #| cache: true
    #| echo: false
    #| fig.width: 8
    #| fig.height: 12
    #| fig.align: center
    data <- tidyr::crossing(x1 = seq(-3, 3, 0.1), x2 = seq(-3, 3, 0.1))
    Mu <- replicate(6, c(0, 0), simplify = FALSE)
    Sigma <- list(
        matrix(c(1, 0, 0, 1), nrow = 2),
        matrix(c(1, 0.2, 0.2, 1), nrow = 2),
        matrix(c(1, 0.5, 0.5, 1), nrow = 2),
        matrix(c(0.1, 0, 0, 1), nrow = 2),
        matrix(c(1, 0.9, 0.9, 1), nrow = 2),
        matrix(c(0.01, 0, 0, 1), nrow = 2)
    )

    index <- 1
    plot_list <- purrr::map2(Mu, Sigma, function(x, y) {
        title_str <- paste0("$\\Sigma_", index, "$")
        plt <- data |>
            mutate(f = mvtnorm::dmvnorm(data, x, y)) |>
            ggplot() +
            geom_raster(aes(x = x1, y = x2, fill = f)) +
            stat_contour(aes(x = x1, y = x2, z = f), col = "white", bins = 5) +
            viridis::scale_fill_viridis() +
            labs(title = latex2exp::TeX(title_str)) + 
            theme(
                legend.position = "none", 
                plot.title = element_text(hjust = 0.5, size = 18)
            )
        index <<- index + 1
        return(plt)
    })

    plt <- Reduce(`+`, plot_list) + 
    plot_layout(ncol = 2)
    plt
    ```

    **Parte 1:** Metropolis-Hastings

    i. Utilice el algoritmo Metropolis-Hastings para obtener $n=10000$ muestras de
    cada una de las distribuciones.
    i. Calcule la probabilidad de aceptación.
    i. Grafique la función de autocorrelación y calcule la cantidad de muestras efectivas.
    i. Analice como varía la probabilidad de aceptación y la cantidad de muestras 
    efectivas según las diferentes características de la distribución objetivo.
    i. ¿Cuáles son las ventajas y desventajas del algoritmo de Metropolis-Hastings según
    lo que puede concluir a partir de esta aplicación? Comente dificultades con las que
    se haya encontrado. 

    **Parte 2:** Hamiltonian Monte Carlo

    i. Utilice el algoritmo HMC para obtener $n=10000$ muestras de
    cada una de las distribuciones.
    i. Calcule la probabilidad de aceptación.
    i. Grafique la función de autocorrelación y calcule la cantidad de muestras efectivas.
    i. Analice como varía la probabilidad de aceptación y la cantidad de muestras 
    efectivas según las diferentes características de la distribución objetivo.
    i. ¿Cuáles son las ventajas y desventajas del algoritmo de Metropolis-Hastings según
    lo que puede concluir a partir de esta aplicación? Comente dificultades con las que
    se haya encontrado. 

    <!-- **To Do** Proveer valores para los parámetros 'mu' y 'sigma'-->


### Ejercicios que faltan

* Utilizar MH para obtener el posterior
    * Utilizar casos de la práctica 2
        * Incluir algún caso donde no todos los parámetros vivan en $\mathbb{R}$
* Utilizar HMC para la normal multivariada con correlación moderada y alta correlación
* Utilizar HMC para los modelos donde se usó MH
* Stan:
    * Escribir algunos modelos con Stan
    * Diferentes priors
    * Analizar posterior de manera grafica (marginales y conjuntas)
    * Calcular diagnosticos y analizar
* Algun caso donde los diagnosticos no den bien...
    * Puede ser cuando el HMC no esta bien tuneado
    * Pensar algunos otros (deberia buscar en cosas que he hecho)
* Algo con brms?

**Nota:** Para los que dicen "utilizar HMC" estaria bueno que proveamos una funcion
que use HMC, sin que tengan que usar Stan.


<!-- 
1. **La maldición de la dimensionalidad**

    **Nota:** Creo que esto puede ir para el TP 2 de este año, o ser parte del TP 2
    del año que viene. Esto todo en el contexto de grid approximation.

    * Mostrar que casi todo el volumen de un hipercubo está en las esquinas.
    * Hablar de la distnacia a la moda en una normal multivariada conforme d -> inftys 

1.  **Tomar el Torus por las astas**

    Ver el script "torus.R"
-->

